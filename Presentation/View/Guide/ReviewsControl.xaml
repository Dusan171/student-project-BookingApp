<Page x:Class="BookingApp.Presentation.View.Guide.ReviewsControl"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:local="clr-namespace:BookingApp.Utilities"
      Title="ReviewsPage"
      Background="#F5F5F5">

    <Page.Resources>
        <local:StarConverter x:Key="StarConverter"/>
        <local:BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter"/>

        <Style x:Key="HoverButtonStyle" TargetType="Button">
            <Setter Property="RenderTransformOrigin" Value="0.5,0.5"/>
            <Setter Property="RenderTransform">
                <Setter.Value>
                    <ScaleTransform ScaleX="1" ScaleY="1"/>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="RenderTransform">
                        <Setter.Value>
                            <ScaleTransform ScaleX="1.1" ScaleY="1.1"/>
                        </Setter.Value>
                    </Setter>
                </Trigger>
            </Style.Triggers>
        </Style>
    </Page.Resources>

    <Grid>
        <StackPanel Margin="16">
            <TextBlock Text="Reviews"
                       FontSize="22" FontWeight="Bold"
                       HorizontalAlignment="Center"
                       Margin="0,0,0,20"/>

            <ScrollViewer VerticalScrollBarVisibility="Auto" Height="540">
                <ItemsControl ItemsSource="{Binding ReviewDisplays}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Margin="0,0,0,16" Padding="14"
                                    CornerRadius="12"
                                    Background="White"
                                    BorderBrush="#DDD" BorderThickness="1">
                                <Border.Effect>
                                    <DropShadowEffect BlurRadius="10" ShadowDepth="2" Opacity="0.25"/>
                                </Border.Effect>

                                <StackPanel>
                                    <StackPanel Orientation="Horizontal" Margin="0,0,0,6">
                                        <TextBlock Text="{Binding TouristName}"
                                                   FontWeight="Bold" FontSize="15"/>
                                        <TextBlock Text="INVALID"
                                                   Foreground="Red" FontWeight="Bold"
                                                   Margin="12,0,0,0">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsValid}" Value="False">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </StackPanel>

                                    <TextBlock Text="{Binding TourName}"
                                               FontSize="13" Foreground="#444" Margin="0,0,0,4"/>
                                    <TextBlock FontWeight="Bold" FontSize="12" Margin="0,0,0,8">
                                        Key Point:
                                        <Run Text="{Binding KeyPointJoinedAt}" FontWeight="Normal"/>
                                    </TextBlock>

                                    <StackPanel Margin="0,0,0,10">
                                        <StackPanel Orientation="Horizontal" Margin="0,2,0,0">
                                            <TextBlock Text="Knowledge: " FontWeight="Bold" Margin="0,0,4,0"/>
                                            <TextBlock Text="{Binding GuideKnowledgeRating, Converter={StaticResource StarConverter}}"
                                                       FontSize="16" Foreground="#FFD700"/>
                                        </StackPanel>
                                        <StackPanel Orientation="Horizontal" Margin="0,2,0,0">
                                            <TextBlock Text="Language: " FontWeight="Bold" Margin="0,0,4,0"/>
                                            <TextBlock Text="{Binding GuideLanguageRating, Converter={StaticResource StarConverter}}"
                                                       FontSize="16" Foreground="#FFD700"/>
                                        </StackPanel>
                                        <StackPanel Orientation="Horizontal" Margin="0,2,0,0">
                                            <TextBlock Text="Interesting: " FontWeight="Bold" Margin="0,0,4,0"/>
                                            <TextBlock Text="{Binding TourInterestRating, Converter={StaticResource StarConverter}}"
                                                       FontSize="16" Foreground="#FFD700"/>
                                        </StackPanel>
                                    </StackPanel>

                                    <TextBlock Text="Comment:" FontWeight="Bold" Margin="0,0,0,4"/>
                                    <TextBlock Text="{Binding Comment}"
                                               TextWrapping="Wrap"
                                               Foreground="#333"
                                               Margin="0,0,0,12"/>

                                    <StackPanel Margin="0,0,0,12"
                                                Visibility="{Binding HasImages, Converter={StaticResource BoolToVisibilityConverter}}">
                                        <TextBlock Text="Images:" FontSize="12" FontWeight="Bold" Margin="0,0,0,5"/>
                                        <ListBox ItemsSource="{Binding ImagePaths}" Height="100" SelectionMode="Single"
                                                 HorizontalAlignment="Left">
                                            <ListBox.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <WrapPanel Orientation="Horizontal"/>
                                                </ItemsPanelTemplate>
                                            </ListBox.ItemsPanel>
                                            <ListBox.ItemTemplate>
                                                <DataTemplate>
                                                    <Image Source="{Binding}" Width="80" Height="80" Margin="5"
                                                           ToolTip="Double-click to preview">
                                                        <Image.InputBindings>
                                                            <MouseBinding MouseAction="LeftDoubleClick"
                                                                          Command="{Binding DataContext.OpenImageCommand, RelativeSource={RelativeSource AncestorType=Page}}"
                                                                          CommandParameter="{Binding}"/>
                                                        </Image.InputBindings>
                                                    </Image>
                                                </DataTemplate>
                                            </ListBox.ItemTemplate>
                                        </ListBox>
                                    </StackPanel>

                                    <Button Content="Report"
                                            Width="100" Height="36"
                                            HorizontalAlignment="Right"
                                            Command="{Binding DataContext.ReportCommand, RelativeSource={RelativeSource AncestorType=Page}}"
                                            CommandParameter="{Binding}"
                                            IsEnabled="{Binding IsValid}"
                                            Background="#E53935"
                                            Foreground="White"
                                            BorderThickness="0"
                                            FontWeight="SemiBold"
                                            Cursor="Hand"
                                            ToolTip="Mark review as invalid">
                                        <Button.Style>
                                            <Style TargetType="Button" BasedOn="{StaticResource HoverButtonStyle}">
                                                <Setter Property="Background" Value="#E53935"/>
                                                <Setter Property="Foreground" Value="White"/>
                                                <Style.Triggers>
                                                    <Trigger Property="IsEnabled" Value="False">
                                                        <Setter Property="Background" Value="#CCC"/>
                                                        <Setter Property="Foreground" Value="#777"/>
                                                        <Setter Property="Cursor" Value="Arrow"/>
                                                    </Trigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Button.Style>
                                    </Button>

                                </StackPanel>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>
        </StackPanel>

        <Border Background="#CC000000"
                Visibility="{Binding IsOverlayVisible, Converter={StaticResource BoolToVisibilityConverter}}"
                Panel.ZIndex="1000">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="50"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="50"/>
                </Grid.ColumnDefinitions>

                <!-- Left arrow -->
                <Button Content="⟨" FontSize="30" Width="40" Height="40" 
                        VerticalAlignment="Center" 
                        Command="{Binding PrevImageCommand}"
                        Background="Transparent" Foreground="White" BorderThickness="0"
                        Grid.Column="0"
                        Cursor="Hand"
                        ToolTip="Previous image"
                        Style="{StaticResource HoverButtonStyle}"/>

                <Image Source="{Binding LargeImage}" Stretch="Uniform" Grid.Column="1"/>

                <Button Content="⟩" FontSize="30" Width="40" Height="40" 
                        VerticalAlignment="Center" 
                        Command="{Binding NextImageCommand}"
                        Background="Transparent" Foreground="White" BorderThickness="0"
                        Grid.Column="2"
                        Cursor="Hand"
                        ToolTip="Next image"
                        Style="{StaticResource HoverButtonStyle}"/>

                <Button Content="X" FontSize="16" Width="35" Height="35"
                        HorizontalAlignment="Right" VerticalAlignment="Top" Margin="10"
                        Command="{Binding CloseOverlayCommand}"
                        Background="Transparent" Foreground="White" BorderThickness="0"
                        Cursor="Hand"
                        ToolTip="Close"
                        Style="{StaticResource HoverButtonStyle}"/>
            </Grid>
        </Border>
    </Grid>
</Page>
